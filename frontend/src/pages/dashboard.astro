---
import "../styles/global.css";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Dashboard - Publimetro URL Shortener" />
    <title>Dashboard | Publimetro URL Shortener</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/png" href="/favicon.png?v=3" />
  </head>
  <body>
    <div class="app-container">
      <header class="header">
        <div class="header-content">
          <img
            src="/publimetro-logo.png"
            alt="Publimetro Shortener"
            class="logo-img"
          />
          <div class="header-stats">
            <span class="header-stat"
              ><strong id="totalLinks">-</strong> links</span
            >
            <span class="header-stat"
              ><strong id="totalClicks">-</strong> clics</span
            >
          </div>
          <button id="logoutBtn" class="btn btn-secondary btn-sm"
            >Cerrar sesión</button
          >
        </div>
      </header>

      <main class="main-content">
        <!-- Top: Create Link Form -->
        <section class="create-section">
          <form id="createForm" class="create-form">
            <div class="url-input-wrapper">
              <input
                type="url"
                id="url"
                class="url-input"
                placeholder="Pega aquí la URL que quieres acortar..."
                required
                autofocus
              />
              <button type="submit" class="btn btn-primary">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                  ></path>
                  <path
                    d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                  ></path>
                </svg>
                Acortar
              </button>
            </div>
            <div class="optional-fields">
              <input
                type="text"
                id="title"
                class="input-optional"
                placeholder="Título (opcional)"
              />
              <input
                type="text"
                id="customCode"
                class="input-optional"
                placeholder="Código personalizado"
                pattern="[a-zA-Z0-9-_]+"
              />
            </div>
          </form>
        </section>

        <!-- Bottom: Links Table -->
        <section class="table-section">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Link Corto</th>
                  <th>Título</th>
                  <th>Clics</th>
                  <th>Creado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="linksTable">
                <tr
                  ><td colspan="5" class="text-center text-muted"
                    >Cargando...</td
                  ></tr
                >
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal de confirmación -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <div class="modal-icon">⚠️</div>
        <h3 class="modal-title">¿Eliminar este link?</h3>
        <p class="modal-text">Esta acción no se puede deshacer.</p>
        <div class="modal-buttons">
          <button id="cancelDelete" class="modal-btn modal-btn-cancel"
            >Cancelar</button
          >
          <button id="confirmDelete" class="modal-btn modal-btn-confirm"
            >Sí, eliminar</button
          >
        </div>
      </div>
    </div>

    <div id="toast" class="toast" style="display: none;"></div>

    <style>
      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      .app-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        flex-shrink: 0;
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid var(--border);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-stats {
        display: flex;
        gap: 1.5rem;
      }

      .header-stat {
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      .header-stat strong {
        color: var(--primary);
        font-size: 1.1rem;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        gap: 1rem;
        overflow: hidden;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      .create-section {
        flex-shrink: 0;
      }

      .create-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .url-input-wrapper {
        display: flex;
        gap: 0.75rem;
      }

      .url-input {
        flex: 1;
        padding: 1rem 1.25rem;
        font-size: 1.1rem;
        background: var(--surface);
        border: 2px solid var(--border);
        border-radius: var(--radius-lg);
        color: var(--text);
        transition: all 0.2s ease;
      }

      .url-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
      }

      .url-input::placeholder {
        color: var(--text-muted);
      }

      .optional-fields {
        display: flex;
        gap: 0.75rem;
      }

      .input-optional {
        flex: 1;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        background: var(--surface-light);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text);
      }

      .input-optional:focus {
        outline: none;
        border-color: var(--primary);
      }

      .table-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
      }

      .table-wrapper {
        flex: 1;
        overflow-y: auto;
      }

      .table-wrapper table {
        width: 100%;
      }

      .table-wrapper th,
      .table-wrapper td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .table-wrapper th {
        position: sticky;
        top: 0;
        background: var(--surface);
        z-index: 10;
        text-align: left;
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid var(--border);
      }

      .table-wrapper tr:hover {
        background: var(--surface-light);
      }

      .short-link-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .short-link {
        font-family: "Fira Code", monospace;
        font-size: 0.9rem;
        color: var(--primary);
        background: var(--surface-light);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
      }

      .copy-btn {
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        padding: 0.35rem 0.6rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        transition: all 0.2s ease;
      }

      .copy-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
      }

      .btn-delete {
        background: rgba(239, 68, 68, 0.15) !important;
        border: 1px solid rgba(239, 68, 68, 0.4) !important;
        color: #ef4444 !important;
        cursor: pointer !important;
        padding: 0.4rem 0.85rem !important;
        border-radius: 6px !important;
        font-size: 0.8rem !important;
        font-weight: 600 !important;
        transition: all 0.2s ease !important;
        letter-spacing: 0.01em;
      }

      .btn-delete:hover {
        background: #ef4444 !important;
        border-color: #ef4444 !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }

      .date-cell {
        color: var(--text-muted);
        font-size: 0.8rem;
      }

      /* Modal de confirmación */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
      }

      .modal-content {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        max-width: 360px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.2s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
      }

      .modal-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .modal-buttons {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
      }

      .modal-btn {
        padding: 0.6rem 1.25rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }

      .modal-btn-cancel {
        background: var(--surface-light);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .modal-btn-cancel:hover {
        background: var(--surface);
        border-color: var(--text-muted);
      }

      .modal-btn-confirm {
        background: #ef4444;
        color: white;
      }

      .modal-btn-confirm:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }

      .logo-img {
        height: 60px;
        width: auto;
        display: block;
      }

      /* ========== RESPONSIVE MOBILE STYLES ========== */
      @media (max-width: 768px) {
        .header {
          padding: 0.5rem 1rem;
        }

        .header-content {
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .logo-img {
          height: 40px;
        }

        .header-stats {
          gap: 0.75rem;
          font-size: 0.75rem;
        }

        .header-stat strong {
          font-size: 0.9rem;
        }

        #logoutBtn {
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
        }

        .main-content {
          padding: 1rem;
          gap: 0.75rem;
        }

        .url-input-wrapper {
          flex-direction: column;
        }

        .url-input {
          padding: 0.75rem 1rem;
          font-size: 0.95rem;
        }

        .btn-primary {
          width: 100%;
          padding: 0.75rem;
        }

        .optional-fields {
          flex-direction: column;
        }

        .input-optional {
          width: 100%;
        }

        .table-section {
          border-radius: var(--radius-md);
        }

        .table-wrapper {
          overflow-x: auto;
        }

        .table-wrapper table {
          min-width: 500px;
        }

        .table-wrapper th,
        .table-wrapper td {
          padding: 0.5rem 0.75rem;
          font-size: 0.8rem;
        }

        .short-link {
          font-size: 0.75rem;
          padding: 0.2rem 0.4rem;
        }

        .copy-btn {
          padding: 0.25rem 0.4rem;
        }

        .date-cell {
          font-size: 0.7rem;
        }

        .toast {
          left: 1rem;
          right: 1rem;
          bottom: 1rem;
          text-align: center;
        }

        .modal-content {
          padding: 1.5rem;
          margin: 1rem;
        }

        .modal-buttons {
          flex-direction: column;
        }

        .modal-btn {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .header-content {
          justify-content: center;
        }

        .header-stats {
          width: 100%;
          justify-content: center;
        }

        #logoutBtn {
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
        }

        .header {
          position: relative;
          padding-top: 2rem;
        }

        .logo-img {
          height: 35px;
        }

        .main-content {
          padding: 0.75rem;
        }

        .url-input {
          font-size: 0.9rem;
          padding: 0.6rem 0.8rem;
        }

        .table-wrapper th:nth-child(2),
        .table-wrapper td:nth-child(2) {
          display: none;
        }

        .table-wrapper th:nth-child(4),
        .table-wrapper td:nth-child(4) {
          display: none;
        }

        .table-wrapper table {
          min-width: auto;
        }
      }
    </style>

    <script>
      const API_URL = "";

      if (sessionStorage.getItem("authenticated") !== "true") {
        window.location.href = "/";
      }

      document.getElementById("logoutBtn")?.addEventListener("click", () => {
        sessionStorage.removeItem("authenticated");
        window.location.href = "/";
      });

      function showToast(
        message: string,
        type: "success" | "error" = "success",
      ) {
        const toast = document.getElementById("toast");
        if (toast) {
          toast.textContent = message;
          toast.className = `toast toast-${type}`;
          toast.style.display = "block";
          setTimeout(() => {
            toast.style.display = "none";
          }, 3000);
        }
      }

      async function copyToClipboard(text: string) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            showToast("¡Link copiado!");
          } else {
            // Fallback para contextos no seguros (HTTP por IP)
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand("copy");
              showToast("¡Link copiado!");
            } catch (err) {
              console.error("Fallback copy failed", err);
              showToast("Error al copiar", "error");
            }
            document.body.removeChild(textArea);
          }
        } catch {
          showToast("Error al copiar", "error");
        }
      }

      function formatDate(dateString: string): string {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-MX", {
          day: "2-digit",
          month: "short",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      async function loadStats() {
        try {
          const response = await fetch(`${API_URL}/api/stats`);
          const stats = await response.json();
          const el = (id: string) => document.getElementById(id);
          if (el("totalLinks"))
            el("totalLinks")!.textContent = stats.total_links;
          if (el("totalClicks"))
            el("totalClicks")!.textContent = stats.total_clicks;
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      async function loadLinks() {
        const tableBody = document.getElementById("linksTable");
        if (!tableBody) return;

        try {
          const response = await fetch(`${API_URL}/api/links`);
          const data = await response.json();

          if (data.links.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No hay links creados</td></tr>`;
            return;
          }

          tableBody.innerHTML = data.links
            .map(
              (link: any) => `
            <tr>
              <td>
                <div class="short-link-cell">
                  <span class="short-link">${link.short_code}</span>
                  <button class="copy-btn" onclick="copyToClipboard('${link.short_url}')" title="Copiar link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                  </button>
                </div>
              </td>
              <td>${link.title || '<span class="text-muted">-</span>'}</td>
              <td><strong>${link.clicks}</strong></td>
              <td class="date-cell">${formatDate(link.created_at)}</td>
              <td><button style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; padding: 0.4rem 0.85rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.color='#ef4444';" onclick="deleteLink(${link.id})">Eliminar</button></td>
            </tr>
          `,
            )
            .join("");
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-error">Error al cargar</td></tr>`;
        }
      }

      let pendingDeleteId: number | null = null;

      function showDeleteModal(id: number) {
        pendingDeleteId = id;
        const modal = document.getElementById("confirmModal");
        if (modal) modal.style.display = "flex";
      }

      function hideDeleteModal() {
        pendingDeleteId = null;
        const modal = document.getElementById("confirmModal");
        if (modal) modal.style.display = "none";
      }

      document
        .getElementById("cancelDelete")
        ?.addEventListener("click", hideDeleteModal);
      document
        .getElementById("confirmDelete")
        ?.addEventListener("click", async () => {
          if (pendingDeleteId === null) return;

          const idToDelete = pendingDeleteId; // Guardar ID
          hideDeleteModal(); // Esto limpia pendingDeleteId

          try {
            console.log(`Intentando eliminar link ID: ${idToDelete}`);
            const response = await fetch(`${API_URL}/api/links/${idToDelete}`, {
              method: "DELETE",
            });

            if (response.ok) {
              showToast("Link eliminado");
              loadLinks();
              loadStats();
            } else {
              const errorText = await response.text();
              console.error(
                "Error respuesta backend:",
                response.status,
                errorText,
              );
              showToast(
                `Error ${response.status}: ${errorText || "Error desconocido"}`,
                "error",
              );
            }
          } catch (error) {
            console.error("Error de conexión:", error);
            showToast(
              `Error de conexión: ${(error as Error).message}`,
              "error",
            );
          }
        });

      document
        .getElementById("confirmModal")
        ?.addEventListener("click", (e) => {
          if (e.target === e.currentTarget) hideDeleteModal();
        });

      async function deleteLink(id: number) {
        showDeleteModal(id);
      }

      document
        .getElementById("createForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const urlInput = document.getElementById("url") as HTMLInputElement;
          const titleInput = document.getElementById(
            "title",
          ) as HTMLInputElement;
          const customCodeInput = document.getElementById(
            "customCode",
          ) as HTMLInputElement;

          const body: any = { url: urlInput.value };
          if (titleInput.value) body.title = titleInput.value;
          if (customCodeInput.value) body.custom_code = customCodeInput.value;

          try {
            const response = await fetch(`${API_URL}/api/links`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            if (response.ok) {
              const link = await response.json();
              showToast("¡Link creado y copiado!");
              await copyToClipboard(link.short_url);
              urlInput.value = "";
              titleInput.value = "";
              customCodeInput.value = "";
              loadLinks();
              loadStats();
            } else {
              const error = await response.json();
              showToast(error.detail || "Error al crear", "error");
            }
          } catch {
            showToast("Error de conexión", "error");
          }
        });

      (window as any).copyToClipboard = copyToClipboard;
      (window as any).deleteLink = deleteLink;
      (window as any).showDeleteModal = showDeleteModal;
      (window as any).hideDeleteModal = hideDeleteModal;

      loadStats();
      loadLinks();
      setInterval(() => {
        loadStats();
        loadLinks();
      }, 30000);
    </script>
  </body>
</html>
